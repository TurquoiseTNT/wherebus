<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <title>Setup | whereBus</title>
        <link rel="stylesheet" href="lang.css">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <link rel="icon" type="image/png" href="/images/wb.png">
        <link rel="apple-touch-icon" href="/images/wb.png">
        <meta name="apple-mobile-web-app-title" content="whereBus">
        <meta name="apple-mobile-web-app-capable" content="yes">
        <meta name="apple-mobile-web-app-status-bar-style" content="black">
    </head>
    <body>
        <h1 class="bold">whereBus</h1>
        <h3 class="bold">Setup</h3>
        <div class="container">
            <div class="row">
              <div class="col-25">
                <label for="fname">Paste Your Ticket ID</label>
              </div>
              <div class="col-75">
                <input type="text" id="ticketid" name="ticketid" placeholder="Enter your Ticket ID or URL here">
              </div>
            </div>
            <br>
            <div class="row">
              <button id="go">Submit</button>
            </div>
        </div>
        <h3 class="bold">Example ID / URL</h3>
        <p>fd30056a-7c27...</p>
        <p>OR</p>
        <p>https://ticket.shuttleid.uk/view/fd30056a-7c27...</p>

        <script>
            const go = document.getElementById("go");
            const ticket = document.getElementById("ticketid");
            async function login(){
              tid = ticket.value;
              if (tid.startsWith("https://ticket.shuttleid.uk/view/")) {
                tid = tid.slice(33);
              } else if (tid.startsWith("http://ticket.shuttleid.uk/view/")) {
                tid = tid.slice(32);
              } else if (tid.startsWith("https://ticket.shuttleid.uk/track/")) {
                tid = tid.slice(34);
              } else if (tid.startsWith("http://ticket.shuttleid.uk/track/")) {
                tid = tid.slice(33);
              }
              const ticketUrl = "https://cors.wherebus.turquoisetnt.one/?" + encodeURI("https://eryqma7z39.execute-api.eu-west-1.amazonaws.com/prod/customer-ticket/" + tid);
              try {
                const res = await fetch(ticketUrl);
                const data = await res.json();
                if (data.hasOwnProperty("error")) {
                  alert("Ticket ID is Invalid");
                  return;
                } else {
                  localStorage.setItem("ticket", tid);
                  window.location.href = "home.html";
                }
              } catch (error) {
                  alert("An Error Occured - Fetch Out: " + error.message);
                  return;
              }
            }

            go.addEventListener("click", function() {
                login();
            });
        </script>
    </body>
</html>
